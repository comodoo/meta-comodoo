From 4a69e82d5a92388d268e6ef689f3fad9e5223ecd Mon Sep 17 00:00:00 2001
From: Enrique de la Torre <indisoluble_dev@me.com>
Date: Sat, 8 Oct 2016 21:23:26 +0200
Subject: [PATCH] Modify to be used in comodoo project

---
 src/agent-helper.py     |  2 +-
 src/eca.py              | 36 +++++++++++++++---------------------
 src/templates/base.html | 18 ++++--------------
 src/view.py             |  3 ++-
 4 files changed, 22 insertions(+), 37 deletions(-)

diff --git a/src/agent-helper.py b/src/agent-helper.py
index f55275e..a66df15 100755
--- a/src/agent-helper.py
+++ b/src/agent-helper.py
@@ -18,7 +18,7 @@
 # Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 
 
-import gobject
+from gi.repository import GObject as gobject
 
 import dbus
 import dbus.service
diff --git a/src/eca.py b/src/eca.py
index d9ba3df..b5de878 100644
--- a/src/eca.py
+++ b/src/eca.py
@@ -28,6 +28,7 @@ from util import get_value, get_str_value, get_properties, get_allowed_users, \
     is_immutable_service, is_cellular_service, get_service_type, \
     set_root_password, set_bt_discoverable, set_cellular_pin, \
     activate_cellular
+from util import set_technology_status, request_rescan
 import technology
 import tethering
 import rescan
@@ -54,8 +55,8 @@ urls = (
     '/cellular', 'Cellular',
 )
 
-title = "ECA Configuration"
-logout = "Logout"
+title = "Internet Connection Configuration"
+logout = "Continue"
 help = "Help"
 
 t_globals = {
@@ -88,20 +89,10 @@ allowed_users_file = "/etc/eca-web/users"
 allowed = get_allowed_users(allowed_users_file)
 
 def is_allowed():
-    global allowed
-    if allowed:
-        return True
-    else:
-        allowed = get_allowed_users(allowed_users_file)
-        if allowed:
-            return True
-        return False
+    return True
 
 def logged():
-    if session.get("logged_in"):
-        return True
-    else:
-        return False
+    return True
 
 new_login_form = form.Form(
     form.Textbox('newuser', form.notnull, description="Web UI username"),
@@ -179,13 +170,20 @@ class Logout:
     def GET(self):
         session.logged_in = False
         session.kill()
-        raise web.seeother('/login')
+
+        app.stop()
 
 class Index:
     def GET(self):
         if not logged():
             raise web.seeother('/login')
 
+        set_technology_status("ethernet", "ON")
+        set_technology_status("wifi", "ON")
+
+        request_rescan("wifi")
+        time.sleep(3)
+
         return view.main_screen()
 
     def POST(self):
@@ -314,16 +312,12 @@ class Edit:
             if input.passphrase == "":
                 return render.edit("Connect Service", format(service),
                                    connect.psk_form)
-            err = connect.service_psk(input, format(service))
-            if err != None:
-                return render.error(err)
+            connect.service_psk(input, format(service))
         elif input.Submit == "new_wep":
             if input.passphrase == "":
                 return render.edit("Connect Service", format(service),
                                    connect.wep_form)
-            err = connect.service_wep(input, format(service))
-            if err != None:
-                return render.error(err)
+            connect.service_wep(input, format(service))
 
         raise web.seeother("/")
 
diff --git a/src/templates/base.html b/src/templates/base.html
index 7199bb7..9f5a7c0 100644
--- a/src/templates/base.html
+++ b/src/templates/base.html
@@ -5,24 +5,14 @@ $def with (page, pagetitle=None, logout=None, help=None)
 $if pagetitle: $pagetitle\
 </title>
 <h2>
-<a class="left-link" href="/logout">\
-$if logout: $logout\
-</a>
-<a class="right-link" href="JavaScript:helpPopup('/static/help.html');">\
+<a class="left-link" href="JavaScript:helpPopup('/static/help.html');">\
 $if help: $help\
 </a>
+<a class="right-link" href="/logout">\
+$if logout: $logout\
+</a>
 </h2>
 <div class="main_forms">
-<div class="main_form_technology">
-<form action="/" method="POST">
-  $:view_technology()
-</form>
-</div>
-<div class="main_form_tethering">
-<form action="/" method="POST">
-  $:view_tethering()
-</form>
-</div>
 <hr>
 <div class="main_form_rescan">
 <div class="main_form_rescan_label">
diff --git a/src/view.py b/src/view.py
index 52d24b2..7abab46 100644
--- a/src/view.py
+++ b/src/view.py
@@ -72,4 +72,5 @@ def main_screen():
     technology.form.get('gadget').value = technology.gadget
 
     return render.base(listing(),
-                       title, logout, help)
+                       title,
+                       logout)
-- 
2.7.4

